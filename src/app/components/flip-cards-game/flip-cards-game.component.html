<!-- Main Game Container -->
<div class="game-container" dir="rtl" cdkDropListGroup>

    <!-- Decorative Sparkles Background -->
    <div class="sparkles-bg"></div>

    <!-- Confetti Overlay (Phase 2 - E4) -->
    <div *ngIf="showConfetti" class="confetti-container">
        <div *ngFor="let piece of confettiPieces" class="confetti-piece" [style.left.%]="piece.left"
            [style.animationDelay.s]="piece.delay" [style.backgroundColor]="piece.color"
            [style.transform]="'rotate(' + piece.rotation + 'deg)'">
        </div>
    </div>

    <!-- Streak Badge (Phase 2) -->
    <div *ngIf="showStreakBadge" class="streak-badge">
        ๐ฅ {{ streak }}x ุณูุณูุฉ! <span class="streak-bonus">+{{ (streak - 2) * 5 }}</span>
    </div>

    <!-- Match Feedback Toast -->
    <div *ngIf="showMatchFeedback" class="match-feedback-toast" [class.success]="matchFeedbackType === 'success'"
        [class.error]="matchFeedbackType === 'error'">
        {{ matchFeedbackText }}
    </div>

    <!-- Card Preview Overlay (Phase 3 - P2) -->
    <div *ngIf="isPreviewPhase" class="preview-overlay">
        <div class="preview-badge">
            <span class="preview-icon">๐</span>
            <span class="preview-text">ุงุญูุธ ููุงูุน ุงูุจุทุงูุงุช!</span>
            <span class="preview-countdown">{{ previewCountdown }}</span>
        </div>
    </div>

    <!-- Pair Explanation Modal (Phase 3 - P3) -->
    <div *ngIf="showExplanation" class="explanation-toast" (click)="dismissExplanation()">
        <div class="explanation-icon">๐ก</div>
        <div class="explanation-body">
            <span class="explanation-pair">{{ explanationPairText }}</span>
            <p class="explanation-text">{{ currentExplanation }}</p>
        </div>
        <button class="explanation-close">โ</button>
    </div>

    <!-- Header Section -->
    <header class="game-header" *ngIf="gameState === 'playing'">
        <div class="header-top">
            <!-- Difficulty Badge (Phase 3 - P1) -->
            <div class="difficulty-badge" [style.borderColor]="difficultyColor">
                <span class="difficulty-stars">
                    <span *ngFor="let s of [1,2,3]" [class.active]="s <= difficultyStars">โญ</span>
                </span>
                <span class="difficulty-label" [style.color]="difficultyColor">{{ difficultyLabel }}</span>
            </div>

            <h1 class="game-title">{{ gameData?.question?.gameTitle || 'ูุนุจุฉ ูุทุงุจูุฉ ุงูุจุทุงูุงุช' }}</h1>

            <!-- Sound Toggle -->
            <button class="sound-toggle" (click)="toggleSound()" [title]="soundEnabled ? 'ูุชู ุงูุตูุช' : 'ุชุดุบูู ุงูุตูุช'">
                {{ soundEnabled ? '๐' : '๐' }}
            </button>
        </div>

        <!-- Instructions Banner (Phase 2 - E7) -->
        <div *ngIf="showInstructions && gameData?.question?.instructions" class="instructions-banner">
            <div class="instructions-content">
                <span class="instructions-icon">๐</span>
                <p>{{ gameData?.question?.instructions }}</p>
            </div>
            <button class="dismiss-btn" (click)="dismissInstructions()">โ</button>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar" [style.width.%]="(matchedPairs / totalPairs) * 100"></div>
        </div>

        <!-- Stats & Stars -->
        <div class="stats-bar">
            <!-- Timer -->
            <div class="stat-pill" *ngIf="timerDisplay">
                <span class="stat-icon">โฑ๏ธ</span>
                <span>{{ timerDisplay }}</span>
                <span *ngIf="gameData?.question?.timerMode === FlipCardTimerMode.CountDown"
                    class="countdown-label">ูุชุจูู</span>
            </div>

            <!-- Moves Counter -->
            <div class="stat-pill">
                <span class="stat-icon">๐</span>
                <span>{{ moves }} ูุญุงููุฉ</span>
            </div>

            <!-- Hint Button (Phase 2 - E2) -->
            <button *ngIf="showHints" class="stat-pill hint-button"
                [disabled]="hintsRemaining <= 0 || isHinting || isProcessing || isPreviewPhase" (click)="useHint()">
                <span class="stat-icon">๐ก</span>
                <span>ุชูููุญ ({{ hintsRemaining }})</span>
            </button>

            <!-- Star Ratings -->
            <div class="star-ratings">
                <span *ngFor="let star of [0,1,2]" class="star" [class.active]="star < stars" role="img">
                    โ
                </span>
            </div>

            <!-- Score -->
            <div class="stat-pill score-pill">
                <span class="stat-icon">๐</span>
                <span>{{ score }} ููุทุฉ</span>
            </div>
        </div>

        <!-- Pairs Progress -->
        <div class="pairs-progress">
            {{ matchedPairs }} / {{ totalPairs }} ุฃุฒูุงุฌ ูุทุงุจูุฉ
            <span *ngIf="streak >= 2" class="streak-indicator">๐ฅ {{ streak }}x</span>
        </div>
    </header>

    <!-- ========== LOADING STATE ========== -->
    <div *ngIf="isLoading" class="loading-state">
        <div class="loading-spinner">๐ฎ</div>
        <p>ุฌุงุฑู ุชุญููู ุงููุนุจุฉ...</p>
    </div>

    <!-- ========== ERROR STATE ========== -->
    <div *ngIf="!isLoading && gameLoadError" class="error-state">
        <div class="error-card">
            <div class="error-icon" *ngIf="hasNoQuestions">๐ญ</div>
            <div class="error-icon" *ngIf="!hasNoQuestions">โ๏ธ</div>
            <h2>{{ hasNoQuestions ? 'ูุง ุชูุฌุฏ ุฃูุนุงุจ ูุชุงุญุฉ' : 'ุญุฏุซ ุฎุทุฃ' }}</h2>
            <p>{{ gameLoadError }}</p>
            <div class="error-actions">
                <button class="retry-button" (click)="retryGame()">
                    ๐ ุญุงูู ูุฑุฉ ุฃุฎุฑู
                </button>
                <button class="exit-button" (click)="exit()">
                    โ ุงูุนูุฏุฉ ูุงุฎุชูุงุฑ ุงููุนุจุฉ
                </button>
            </div>
        </div>
    </div>

    <!-- ========== START SCREEN ========== -->
    <div *ngIf="!isLoading && !gameLoadError && gameState === 'start'" class="start-screen">
        <div class="start-card">
            <div class="start-icon">๐ง</div>
            <h2>ูู ุฃูุช ูุณุชุนุฏุ</h2>
            <p>ุทุงุจู ุงูุฅุฌุงุจุงุช ุจุงูุฃุณุฆูุฉ ุงูุตุญูุญุฉ</p>
        </div>
    </div>

    <!-- ========== PLAYING STATE ========== -->
    <div *ngIf="!isLoading && !gameLoadError && (gameState === 'playing' || gameState === 'complete')" class="w-full">

        <!-- CLASSIC MODE GRID -->
        <div *ngIf="gameData?.gameMode === FlipCardGameMode.Classic" class="classic-grid"
            [style.grid-template-columns]="'repeat(' + gridColumns + ', 1fr)'">
            <div *ngFor="let card of cards" class="memory-card" [class.flipped]="card.isFlipped || card.isMatched"
                [class.matched]="card.isMatched" [class.shake]="card.shake" [class.hinted]="card.isHinted"
                [class.preview-card]="isPreviewPhase" (click)="!isPreviewPhase && flipCard(card)">

                <div class="memory-face card-front">
                    <!-- Text Content -->
                    <div *ngIf="card.type === FlipCardContentType.Text" class="card-text-content">
                        {{ card.text }}
                    </div>
                    <!-- Image Content -->
                    <div *ngIf="card.type === FlipCardContentType.Image" class="card-image-content">
                        <img [src]="card.imageUrl" [alt]="card.text || 'Card Image'" class="card-img">
                        <p *ngIf="card.text" class="card-image-label">{{ card.text }}</p>
                    </div>
                    <!-- Audio Content -->
                    <div *ngIf="card.type === FlipCardContentType.Audio" class="audio-card-content"
                        (click)="$event.stopPropagation(); playAudio(card)">
                        <span class="audio-icon" [class.playing]="card.isPlayingAudio">
                            {{ card.isPlayingAudio ? '๐' : '๐' }}
                        </span>
                        <p class="audio-label">{{ card.text || 'ุงุถุบุท ููุงุณุชูุงุน' }}</p>
                        <div *ngIf="card.isPlayingAudio" class="audio-wave">
                            <span></span><span></span><span></span><span></span>
                        </div>
                    </div>
                    <!-- Match indicator -->
                    <div *ngIf="card.isMatched" class="card-match-check">โ</div>
                </div>

                <div class="memory-face card-back">
                    <span class="card-back-icon">?</span>
                </div>
            </div>
        </div>

        <!-- MATCH MODE GRID -->
        <div *ngIf="gameData?.gameMode === FlipCardGameMode.Match" class="game-grid">

            <!-- Answers Column -->
            <section class="game-section answers-section">
                <h2 class="section-title">ุงูุฅุฌุงุจุงุช</h2>
                <div class="cards-container">
                    <div *ngFor="let card of leftCards" class="card-wrapper">
                        <div *ngIf="!card.isMatched" cdkDrag [cdkDragData]="card"
                            class="flip-card answer-card draggable" [class.hinted]="card.isHinted">

                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <div *ngIf="card.type === FlipCardContentType.Text" class="card-text">
                                        {{ card.text }}
                                    </div>
                                    <div *ngIf="card.type === FlipCardContentType.Image" class="card-image">
                                        <img [src]="card.imageUrl" [alt]="card.text || 'Image'" class="match-card-img">
                                    </div>
                                    <div *ngIf="card.type === FlipCardContentType.Audio" class="card-audio"
                                        (click)="$event.stopPropagation(); playAudio(card)">
                                        <span class="audio-icon" [class.playing]="card.isPlayingAudio">
                                            {{ card.isPlayingAudio ? '๐' : '๐' }}
                                        </span>
                                        <span>{{ card.text || 'ุงุณุชูุน' }}</span>
                                    </div>
                                    <div class="drag-hint">ุงุณุญุจูู!</div>
                                </div>
                            </div>

                            <div *cdkDragPreview class="drag-preview">
                                <span>{{ card.text || 'Image' }}</span>
                            </div>
                        </div>

                        <div *ngIf="card.isMatched" class="matched-placeholder">
                            <span>โ</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Divider -->
            <div class="center-divider">
                <div class="divider-line"></div>
            </div>

            <!-- Questions Column -->
            <section class="game-section questions-section">
                <h2 class="section-title">ุงูุฃุณุฆูุฉ</h2>
                <div class="cards-container">
                    <div *ngFor="let card of rightCards" class="card-wrapper" cdkDropList [cdkDropListData]="card"
                        (cdkDropListDropped)="onDrop($event, card)">

                        <div class="flip-card question-card" [class.matched]="card.isMatched" [class.shake]="card.shake"
                            [class.celebrate]="card.celebrate" [class.hinted]="card.isHinted">

                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <div *ngIf="card.type === FlipCardContentType.Text" class="card-text">
                                        {{ card.text }}
                                    </div>
                                    <div *ngIf="card.type === FlipCardContentType.Image" class="card-image">
                                        <img [src]="card.imageUrl" [alt]="card.text || 'Image'" class="match-card-img">
                                    </div>
                                    <div *ngIf="card.type === FlipCardContentType.Audio" class="card-audio"
                                        (click)="playAudio(card)">
                                        <span class="audio-icon" [class.playing]="card.isPlayingAudio">
                                            {{ card.isPlayingAudio ? '๐' : '๐' }}
                                        </span>
                                        <span>{{ card.text || 'ุงุณุชูุน' }}</span>
                                    </div>

                                    <div *ngIf="card.isMatched" class="match-badge">โ</div>
                                    <div *ngIf="!card.isMatched" class="drop-hint">ุถุน ุงูุฅุฌุงุจุฉ ููุง</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </div>

    <!-- ========== VICTORY MODAL ========== -->
    <div *ngIf="gameState === 'complete'" class="victory-overlay">
        <div class="victory-modal">
            <!-- Loading state -->
            <div *ngIf="isCalculatingResult" class="calculating-result">
                <div class="loading-spinner">๐ฏ</div>
                <p>ุฌุงุฑู ุญุณุงุจ ุงููุชูุฌุฉ...</p>
            </div>

            <!-- Result content -->
            <div *ngIf="!isCalculatingResult">
                <div class="victory-icon">๐</div>
                <h2>ุฃุญุณูุช!</h2>
                <p>ุฃูููุช ุงููุนุจุฉ ุจูุฌุงุญ!</p>

                <!-- Star Rating -->
                <div class="victory-stars">
                    <span *ngFor="let star of [0,1,2]" class="victory-star" [class.active]="star < stars">
                        โ
                    </span>
                </div>

                <!-- Stats Grid -->
                <div class="stats">
                    <div class="stat">
                        <span class="stat-value">{{ score }}</span>
                        <span class="stat-label">ููุงุท</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">{{ timerSeconds }}s</span>
                        <span class="stat-label">ุซุงููุฉ</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">{{ moves }}</span>
                        <span class="stat-label">ูุญุงููุงุช</span>
                    </div>
                    <div class="stat" *ngIf="bestStreak > 0">
                        <span class="stat-value">๐ฅ {{ bestStreak }}</span>
                        <span class="stat-label">ุฃูุถู ุณูุณูุฉ</span>
                    </div>
                    <div class="stat" *ngIf="streakBonusPoints > 0">
                        <span class="stat-value bonus-value">+{{ streakBonusPoints }}</span>
                        <span class="stat-label">ููุงูุฃุฉ ุงูุณูุณูุฉ</span>
                    </div>
                </div>

                <!-- Achievements -->
                <div *ngIf="achievements.length > 0" class="achievements-section">
                    <h3>๐ ุงูุฅูุฌุงุฒุงุช</h3>
                    <div class="achievements-list">
                        <span *ngFor="let badge of achievements" class="achievement-badge">
                            {{ badge }}
                        </span>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div *ngIf="showLeaderboard" class="leaderboard-section">
                    <h3>๐ ููุญุฉ ุงููุชุตุฏุฑูู</h3>
                    <div class="leaderboard-list">
                        <div *ngFor="let entry of leaderboardEntries; let i = index" class="leaderboard-entry"
                            [class.top-three]="i < 3">
                            <span class="lb-rank">{{ entry.rank }}</span>
                            <span class="lb-name">{{ entry.studentName }}</span>
                            <span class="lb-score">{{ entry.totalScore }} ููุทุฉ</span>
                        </div>
                    </div>
                </div>

                <!-- Difficulty Progression -->
                <button *ngIf="canPlayHarder" class="next-difficulty-button" (click)="playNextDifficulty()">
                    ๐ ุชุญุฏู ุฃุตุนุจ!
                </button>

                <button class="replay-button" (click)="playAgain()">
                    ุงูุนุจ ูุฑุฉ ุฃุฎุฑู ๐
                </button>
                <button class="exit-button" (click)="exit()">
                    ุฎุฑูุฌ
                </button>
            </div>
        </div>
    </div>
</div>