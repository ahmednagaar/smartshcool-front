<div class="game-container min-h-screen font-cairo" dir="rtl" cdkDropListGroup [class.high-contrast]="highContrastMode"
    [class]="uiThemeClass" role="application" (touchstart)="onContainerTouch($event)">

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">ุฌุงุฑู ุชุญููู ุงููุนุจุฉ...</p>
        </div>
    </div>

    <div *ngIf="!isLoading">
        <!-- Parallax Background -->
        <div class="parallax-bg"></div>

        <!-- Tutorial Overlay -->
        <div *ngIf="showTutorial" class="tutorial-overlay" (click)="dismissTutorial()">
            <div class="tutorial-content" (click)="$event.stopPropagation()">
                <div class="tutorial-icon">๐ฎ</div>
                <h2 class="tutorial-title">ุฃููุงู! ุฏุนูุง ูุชุนูู ููู ููุนุจ</h2>

                <div class="tutorial-steps">
                    <div class="tutorial-step">
                        <span class="step-number">1</span>
                        <span class="step-text" *ngIf="inputMode === 'tap'">ุงุถุบุท ุนูู ุงูุจุทุงูุฉ ูุงุฎุชูุงุฑูุง</span>
                        <span class="step-text" *ngIf="inputMode === 'drag'">ุงุณุญุจ ุงูุจุทุงูุฉ ูู ุงููุฎุฒู</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="step-number">2</span>
                        <span class="step-text" *ngIf="inputMode === 'tap'">ุซู ุงุถุบุท ุนูู ุงูููุทูุฉ ุงูุตุญูุญุฉ</span>
                        <span class="step-text" *ngIf="inputMode === 'drag'">ุฃููุชูุง ูู ุงูููุทูุฉ ุงูููุงุณุจุฉ</span>
                    </div>
                    <div class="tutorial-step">
                        <span class="step-number">3</span>
                        <span class="step-text">ุฅุฐุง ุฃุฎุทุฃุชุ ูุง ุชููู! ุญุงูู ูุฑุฉ ุฃุฎุฑู</span>
                    </div>
                </div>

                <div class="tutorial-actions">
                    <button (click)="dismissTutorial()" class="btn-primary tutorial-btn">ูููุช! ุงุจุฏุฃ ุงููุนุจ ๐ฎ</button>
                    <label class="tutorial-checkbox">
                        <input type="checkbox" [(ngModel)]="neverShowTutorial" />
                        <span>ูุง ุชุนุฑุถ ูุฐุง ูุฑุฉ ุฃุฎุฑู</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast-container" [class.show]="showToast">
            <div class="toast" [class.toast-success]="toastType === 'success'"
                [class.toast-error]="toastType === 'error'">
                <span class="toast-icon">{{ toastType === 'success' ? '๐' : '๐ช' }}</span>
                <span class="toast-message">{{ toastMessage }}</span>
            </div>
        </div>

        <!-- ========== GAME SCREEN ========== -->
        <div class="container game-area relative z-10">

            <!-- Header -->
            <header class="game-header">
                <button (click)="goBack()" class="btn-ghost" aria-label="ุฑุฌูุน">
                    <span class="text-xl">โ</span>
                    <span class="font-bold text-white">ุฎุฑูุฌ</span>
                </button>

                <div class="header-center">
                    <h1 class="game-title">
                        {{ session?.gameTitle }}
                    </h1>
                    <p class="game-instructions">{{ session?.instructions || 'ุงุณุญุจ ุงูุนูุงุตุฑ ุฅูู ุงูุชุตููู ุงูุตุญูุญ' }}</p>
                </div>

                <div class="header-right">
                    <!-- Input Mode Toggle (mobile only) -->
                    <button *ngIf="isMobile" (click)="toggleInputMode()" class="mode-toggle-btn"
                        [title]="inputMode === 'tap' ? 'ุงูุชุจุฏูู ุฅูู ุงูุณุญุจ' : 'ุงูุชุจุฏูู ุฅูู ุงูุถุบุท'">
                        {{ inputMode === 'tap' ? '๐' : 'โ' }}
                    </button>

                    <!-- Hint Button -->
                    <button (click)="useHint()" class="hint-btn" [disabled]="hintsRemaining <= 0"
                        [title]="'ูุณุงุนุฏุฉ (' + hintsRemaining + ')'">
                        ๐ก
                        <span class="hint-count">{{ hintsRemaining }}</span>
                    </button>

                    <button (click)="toggleMute()" class="mute-btn">
                        {{ isMuted ? '๐' : '๐' }}
                    </button>

                    <div class="score-badge" role="status">
                        <span class="score-value">{{ currentScore }}</span>
                        <span class="score-label">ููุทุฉ</span>
                    </div>
                </div>
            </header>

            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="progressPercentage"></div>
                </div>
                <span class="progress-text">{{ placedItemsCount }}/{{ totalItemsCount }} ุจุทุงูุงุช</span>
            </div>

            <!-- ========== DESKTOP LAYOUT (โฅ1024px) ========== -->
            <div class="desktop-layout">
                <div class="grid lg:grid-cols-12 gap-6 items-start">

                    <!-- Source Store (Desktop) -->
                    <div class="lg:col-span-4 lg:order-2">
                        <div class="store-card glass-card p-5">
                            <h3 class="store-title">
                                <span>๐ฆ</span> ุงููุฎุฒู
                                <span class="store-count">{{ availableItems.length }} ูุชุจููุฉ</span>
                            </h3>

                            <div cdkDropList [cdkDropListData]="availableItems" class="store-items-list"
                                (cdkDropListDropped)="drop($event, -1)" [id]="'store-list'">

                                <div *ngFor="let item of availableItems; let i = index" cdkDrag [cdkDragData]="item"
                                    class="item-card glass-shimmer" [class.selected]="selectedItem?.id === item.id"
                                    [class.hint-highlight]="hintItemId === item.id" (click)="onItemTap(item)"
                                    [attr.aria-label]="item.text">

                                    <div class="item-content">
                                        <span class="item-text">{{ item.text }}</span>
                                        <span class="drag-handle" *ngIf="inputMode === 'drag'">โฎโฎ</span>
                                        <span class="tap-indicator"
                                            *ngIf="inputMode === 'tap' && selectedItem?.id === item.id">โ</span>
                                    </div>

                                    <div *cdkDragPlaceholder class="drag-placeholder">
                                        <span class="placeholder-text">{{ item.text }}</span>
                                    </div>
                                </div>

                                <div *ngIf="availableItems.length === 0" class="empty-store">
                                    <p>โจ ุฃุญุณูุช! ุงูุชูุช ุงูุนูุงุตุฑ!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Drop Zones (Desktop) -->
                    <div class="lg:col-span-8 lg:order-1">
                        <div class="grid gap-5" [ngClass]="getZoneGridClass()">
                            <div *ngFor="let zone of zones"
                                class="zone-card glass-card overflow-hidden transition-all duration-300"
                                [class.zone-droppable]="isDragging || selectedItem"
                                [class.zone-hint]="hintZoneId === zone.id" [style.borderColor]="zone.colorCode"
                                (click)="onZoneTap(zone.id)">

                                <div class="zone-header" [style.background]="zone.colorCode">
                                    <h3 class="zone-label">
                                        {{ zone.label }}
                                        <img *ngIf="zone.iconUrl" [src]="zone.iconUrl" class="zone-icon" />
                                    </h3>
                                    <span class="zone-count" *ngIf="zoneItems[zone.id]?.length">{{
                                        zoneItems[zone.id].length }}</span>
                                </div>

                                <div cdkDropList [cdkDropListData]="zoneItems[zone.id]" class="zone-content"
                                    (cdkDropListDropped)="drop($event, zone.id)" [id]="'zone-' + zone.id">

                                    <div *ngFor="let item of zoneItems[zone.id]" cdkDrag [cdkDragDisabled]="true"
                                        class="zone-item item-correct">
                                        <span class="item-text">{{ item.text }}</span>
                                        <span class="result-check">โ</span>
                                    </div>

                                    <div *ngIf="!zoneItems[zone.id]?.length" class="zone-empty">
                                        <p *ngIf="selectedItem">ุงุถุบุท ููุง ููุฅููุงุช</p>
                                        <p *ngIf="!selectedItem">ุงุณุญุจ ููุง</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== MOBILE LAYOUT (<1024px) ========== -->
            <div class="mobile-layout">
                <div class="mobile-game-area">

                    <!-- Store (Mobile - Left Side) -->
                    <div class="mobile-store">
                        <h3 class="mobile-store-title">๐ฆ ุงููุฎุฒู</h3>

                        <div cdkDropList [cdkDropListData]="availableItems" class="mobile-store-items"
                            (cdkDropListDropped)="drop($event, -1)" [id]="'store-list-mobile'">

                            <div *ngFor="let item of availableItems" cdkDrag [cdkDragData]="item"
                                class="mobile-item-card" [class.selected]="selectedItem?.id === item.id"
                                [class.hint-highlight]="hintItemId === item.id"
                                [class.shake-error]="shakeItemId === item.id" (click)="onItemTap(item)"
                                [attr.aria-label]="item.text">

                                <span class="mobile-item-text">{{ item.text }}</span>
                                <span class="mobile-tap-check" *ngIf="selectedItem?.id === item.id">โ</span>

                                <div *cdkDragPlaceholder class="drag-placeholder mobile-placeholder">
                                    <span>{{ item.text }}</span>
                                </div>
                            </div>

                            <div *ngIf="availableItems.length === 0" class="mobile-empty-store">
                                <span>โจ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Zones (Mobile - Right Side, Horizontal Scroll) -->
                    <div class="mobile-zones-wrapper">
                        <!-- Zone Dots -->
                        <div class="zone-dots" *ngIf="zones.length > 1">
                            <span *ngFor="let zone of zones; let i = index" class="zone-dot"
                                [class.active]="activeZoneIndex === i" (click)="scrollToZone(i)"></span>
                        </div>

                        <div class="mobile-zones-scroll" #mobileZonesScroll (scroll)="onZoneScroll($event)">
                            <div *ngFor="let zone of zones; let i = index" class="mobile-zone-card"
                                [class.zone-droppable]="isDragging || selectedItem"
                                [class.zone-hint]="hintZoneId === zone.id" [style.borderColor]="zone.colorCode"
                                (click)="onZoneTap(zone.id)" [id]="'mobile-zone-' + zone.id">

                                <div class="mobile-zone-header" [style.background]="zone.colorCode">
                                    <h3 class="mobile-zone-label">{{ zone.label }}</h3>
                                    <span class="mobile-zone-counter">{{ zoneItems[zone.id]?.length || 0 }}</span>
                                </div>

                                <div cdkDropList [cdkDropListData]="zoneItems[zone.id]" class="mobile-zone-content"
                                    (cdkDropListDropped)="drop($event, zone.id)" [id]="'zone-mobile-' + zone.id">

                                    <div *ngFor="let item of zoneItems[zone.id]" cdkDrag [cdkDragDisabled]="true"
                                        class="mobile-zone-item item-correct">
                                        <span>{{ item.text }}</span>
                                        <span class="result-check">โ</span>
                                    </div>

                                    <div *ngIf="!zoneItems[zone.id]?.length" class="mobile-zone-empty">
                                        <div class="zone-empty-icon">๐ฏ</div>
                                        <p *ngIf="selectedItem" class="zone-empty-action">ุงุถุบุท ููุง!</p>
                                        <p *ngIf="!selectedItem" class="zone-empty-hint">ุงุณุญุจ ุฃู ุงุถุบุท ุจุทุงูุฉ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Item Floating Indicator (Mobile) -->
                <div *ngIf="selectedItem && inputMode === 'tap'" class="selected-indicator">
                    <span class="selected-indicator-text">โ {{ selectedItem.text }} โ ุงุถุบุท ุนูู ุงูููุทูุฉ ุงูุตุญูุญุฉ</span>
                    <button (click)="deselectItem()" class="deselect-btn">โ</button>
                </div>
            </div>

            <!-- ========== HINT OVERLAY ========== -->
            <div *ngIf="showHintLine" class="hint-line-overlay">
                <div class="hint-message">๐ก ูุฐู ุงูุจุทุงูุฉ ุชุฐูุจ ููุง</div>
            </div>

            <!-- Results Modal -->
            <div *ngIf="showResults" class="modal-overlay animate-fade-in">
                <div class="modal-content animate-bounce-in">
                    <!-- Confetti -->
                    <div class="confetti-container">
                        <div *ngFor="let c of confettiPieces" class="confetti-piece" [style.left.%]="c.x"
                            [style.animationDelay.s]="c.delay" [style.background]="c.color"></div>
                    </div>

                    <div class="result-icon-large">
                        {{ gameResult?.stars === 3 ? '๐' : (gameResult?.stars === 2 ? '๐' : '๐') }}
                    </div>
                    <h3 class="result-title">{{ getCompletionMessage() }}</h3>
                    <p class="result-subtitle">
                        ุงูููุงุท: <strong class="score-highlight">{{ gameResult?.totalScore }}</strong> / {{
                        gameResult?.maxPossibleScore }}
                    </p>

                    <div class="stars-row">
                        <span *ngFor="let s of [1,2,3]" class="star" [class.earned]="(gameResult?.stars || 0) >= s"
                            [style.animationDelay.ms]="s * 200">โญ</span>
                    </div>

                    <div *ngIf="gameResult?.timeSpentSeconds" class="time-display">
                        โฑ๏ธ ุฃูููุช ูู {{ formatTime(gameResult!.timeSpentSeconds) }}
                    </div>

                    <div class="modal-actions">
                        <button (click)="restartGame()" class="btn-secondary">๐ ุงูุนุจ ูุฑุฉ ุฃุฎุฑู</button>
                        <button (click)="goBack()" class="btn-primary">๐ ุงูุนูุฏุฉ</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>