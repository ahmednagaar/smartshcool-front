<!-- ========== LOADING SCREEN ========== -->
<div class="game-container" *ngIf="!isLoading && session; else loadingTpl" (touchstart)="onContainerTouch($event)">

    <!-- Toast Notification -->
    <div class="toast-notification" *ngIf="showToast" [class.toast-success]="toastType === 'success'"
        [class.toast-error]="toastType === 'error'" [class.toast-info]="toastType === 'info'" role="alert"
        aria-live="polite">
        {{ toastMessage }}
    </div>

    <!-- Explanation Overlay -->
    <div class="explanation-overlay" *ngIf="showExplanation" (click)="dismissExplanation()">
        <div class="explanation-bubble">
            <span class="explanation-icon">๐ก</span>
            <p>{{ explanationText }}</p>
        </div>
    </div>

    <!-- Streak Celebration -->
    <div class="streak-celebration" *ngIf="showStreakCelebration">
        <span class="streak-fire">๐ฅ</span>
        <span class="streak-count">{{ currentStreak }}</span>
    </div>

    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" *ngIf="showTutorial" (click)="$event.stopPropagation()">
        <div class="tutorial-card animate-bounce-in">
            <h2 class="tutorial-title">๐ฎ ููู ุชูุนุจุ</h2>
            <div class="tutorial-steps">
                <div class="tutorial-step">
                    <span class="step-number">1</span>
                    <p *ngIf="inputMode === 'tap'">ุงุถุบุท ุนูู ุงูุจุทุงูุฉ ูู ุงููุฎุฒู</p>
                    <p *ngIf="inputMode === 'drag'">ุงุณุญุจ ุงูุจุทุงูุฉ ูู ุงููุฎุฒู</p>
                </div>
                <div class="tutorial-step">
                    <span class="step-number">2</span>
                    <p *ngIf="inputMode === 'tap'">ุซู ุงุถุบุท ุนูู ุงูููุทูุฉ ุงูุตุญูุญุฉ</p>
                    <p *ngIf="inputMode === 'drag'">ุฃููุชูุง ูู ุงูููุทูุฉ ุงูุตุญูุญุฉ</p>
                </div>
                <div class="tutorial-step">
                    <span class="step-number">3</span>
                    <p>ุฃููู ุฌููุน ุงูุจุทุงูุงุช ูุฅููุงุก ุงููุนุจุฉ! ๐</p>
                </div>
            </div>
            <div class="tutorial-tips">
                <p>๐ก ุงุถุบุท "ูุณุงุนุฏุฉ" ุฅุฐุง ุงุญุชุฌุช ุชูููุญ</p>
                <p>โจ๏ธ ููููู ุงุณุชุฎุฏุงู ุงูุฃุณูู + Enter</p>
                <p>๐ ุงุถุบุท ุฒุฑ ุงูุฎูุท ูุชุบููุฑ ุชุฑุชูุจ ุงูุจุทุงูุงุช</p>
            </div>
            <label class="tutorial-checkbox">
                <input type="checkbox" [(ngModel)]="neverShowTutorial" />
                ูุง ุชุนุฑุถ ูุฑุฉ ุฃุฎุฑู
            </label>
            <button class="tutorial-btn" (click)="dismissTutorial()">ูููุช! ุงุจุฏุฃ ุงููุนุจ ๐ฎ</button>
        </div>
    </div>

    <!-- ========== GAME SCREEN ========== -->
    <div class="container game-area relative z-10">

        <!-- Header -->
        <header class="game-header">
            <button (click)="goBack()" class="btn-ghost" aria-label="ุฑุฌูุน">
                <span class="text-xl">โ</span>
                <span class="font-bold text-white">ุฎุฑูุฌ</span>
            </button>

            <div class="header-center">
                <h1 class="game-title">
                    {{ session?.gameTitle }}
                </h1>
                <p class="game-instructions">{{ session?.instructions || 'ุงุณุญุจ ุงูุนูุงุตุฑ ุฅูู ุงูุชุตููู ุงูุตุญูุญ' }}</p>
            </div>

            <div class="header-right">
                <!-- Timer -->
                <div class="timer-badge" *ngIf="timerEnabled" [class.timer-green]="timerColor === 'green'"
                    [class.timer-yellow]="timerColor === 'yellow'" [class.timer-red]="timerColor === 'red'" role="timer"
                    [attr.aria-label]="'ุงูููุช ุงููุชุจูู: ' + formatTimer(timerSeconds)">
                    <span class="timer-icon">โฑ๏ธ</span>
                    <span class="timer-text">{{ formatTimer(timerSeconds) }}</span>
                    <div class="timer-bar">
                        <div class="timer-bar-fill" [style.width.%]="timerPercentage"></div>
                    </div>
                </div>

                <!-- Streak -->
                <div class="streak-badge" *ngIf="currentStreak >= 2" [class.streak-hot]="currentStreak >= 5"
                    role="status" [attr.aria-label]="'ุณูุณูุฉ: ' + currentStreak">
                    ๐ฅ {{ currentStreak }}
                </div>

                <!-- Shuffle -->
                <button (click)="shuffleItems()" class="shuffle-btn" [disabled]="availableItems.length <= 1"
                    title="ุฎูุท ุงูุจุทุงูุงุช" aria-label="ุฎูุท ุงูุจุทุงูุงุช">
                    ๐
                </button>

                <!-- Undo -->
                <button (click)="undoLastMove()" class="undo-btn" [disabled]="!canUndo" title="ุชุฑุงุฌุน"
                    aria-label="ุชุฑุงุฌุน ุนู ุขุฎุฑ ุญุฑูุฉ">
                    โฉ๏ธ
                </button>

                <!-- Input Mode Toggle (mobile only) -->
                <button *ngIf="isMobile" (click)="toggleInputMode()" class="mode-toggle-btn"
                    [title]="inputMode === 'tap' ? 'ุงูุชุจุฏูู ุฅูู ุงูุณุญุจ' : 'ุงูุชุจุฏูู ุฅูู ุงูุถุบุท'">
                    {{ inputMode === 'tap' ? '๐' : 'โ' }}
                </button>

                <!-- Hint Button -->
                <button (click)="useHint()" class="hint-btn" [disabled]="hintsRemaining <= 0"
                    [title]="'ูุณุงุนุฏุฉ (' + hintsRemaining + ')'">
                    ๐ก
                    <span class="hint-count">{{ hintsRemaining }}</span>
                </button>

                <button (click)="toggleMute()" class="mute-btn">
                    {{ isMuted ? '๐' : '๐' }}
                </button>

                <div class="score-badge" role="status">
                    <span class="score-value">{{ currentScore }}</span>
                    <span class="score-label">ููุทุฉ</span>
                </div>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="progressPercentage"></div>
            </div>
            <span class="progress-text">{{ placedItemsCount }}/{{ totalItemsCount }} ุจุทุงูุงุช</span>
        </div>

        <!-- ========== DESKTOP LAYOUT (โฅ1024px) ========== -->
        <div class="desktop-layout">
            <div class="grid lg:grid-cols-12 gap-6 items-start">

                <!-- Source Store (Desktop) -->
                <div class="lg:col-span-4 lg:order-2">
                    <div class="store-card glass-card p-5">
                        <h3 class="store-title">
                            <span>๐ฆ</span> ุงููุฎุฒู
                            <span class="store-count">{{ availableItems.length }} ูุชุจููุฉ</span>
                        </h3>

                        <div cdkDropList [cdkDropListData]="availableItems" class="store-items-list"
                            (cdkDropListDropped)="drop($event, -1)" [id]="'store-list'">

                            <div *ngFor="let item of availableItems; let i = index" cdkDrag [cdkDragData]="item"
                                class="item-card glass-shimmer" [class.selected]="selectedItem?.id === item.id"
                                [class.hint-highlight]="hintItemId === item.id"
                                [class.keyboard-focused]="focusedItemIndex === i"
                                [class.shake-error]="shakeItemId === item.id" (click)="onItemTap(item)"
                                (cdkDragStarted)="onDragStarted($event)" (cdkDragEnded)="onDragEnded($event)"
                                [attr.aria-label]="item.text" [attr.tabindex]="0" role="button">

                                <div class="item-content">
                                    <img *ngIf="item.imageUrl" [src]="item.imageUrl" class="item-image"
                                        [alt]="item.text" />
                                    <span class="item-text">{{ item.text }}</span>
                                    <div class="item-actions">
                                        <button *ngIf="item.audioUrl" class="item-audio-btn"
                                            (click)="playItemAudio(item, $event)"
                                            [class.playing]="playingAudioItemId === item.id" aria-label="ุชุดุบูู ุงูุตูุช">
                                            {{ playingAudioItemId === item.id ? 'โธ๏ธ' : '๐' }}
                                        </button>
                                        <span class="drag-handle" *ngIf="inputMode === 'drag'">โฎโฎ</span>
                                        <span class="tap-indicator"
                                            *ngIf="inputMode === 'tap' && selectedItem?.id === item.id">โ</span>
                                    </div>
                                </div>

                                <div *cdkDragPlaceholder class="drag-placeholder">
                                    <span class="placeholder-text">{{ item.text }}</span>
                                </div>
                            </div>

                            <div *ngIf="availableItems.length === 0" class="empty-store">
                                <p class="empty-store-celebration">โจ ุฃุญุณูุช! ุงูุชูุช ุงูุนูุงุตุฑ!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Drop Zones (Desktop) -->
                <div class="lg:col-span-8 lg:order-1">
                    <div class="grid gap-5" [ngClass]="getZoneGridClass()">
                        <div *ngFor="let zone of zones; let zi = index"
                            class="zone-card glass-card overflow-hidden transition-all duration-300"
                            [class.zone-droppable]="isDragging || selectedItem"
                            [class.zone-hint]="hintZoneId === zone.id"
                            [class.keyboard-focused]="focusedZoneIndex === zi" [style.borderColor]="zone.colorCode"
                            (click)="onZoneTap(zone.id)" [attr.tabindex]="0" role="region"
                            [attr.aria-label]="'ููุทูุฉ: ' + zone.label">

                            <div class="zone-header" [style.background]="zone.colorCode">
                                <div class="zone-header-left">
                                    <span class="zone-number-badge">{{ getZoneNumber(zone.id) }}</span>
                                    <h3 class="zone-label">
                                        {{ zone.label }}
                                        <img *ngIf="zone.iconUrl" [src]="zone.iconUrl" class="zone-icon" />
                                    </h3>
                                </div>
                                <span class="zone-count-badge">
                                    {{ getZonePlacedCount(zone.id) }}/{{ getZoneExpectedCount(zone.id) }}
                                </span>
                            </div>

                            <div cdkDropList [cdkDropListData]="zoneItems[zone.id]" class="zone-content"
                                (cdkDropListDropped)="drop($event, zone.id)" [id]="'zone-' + zone.id">

                                <div *ngFor="let item of zoneItems[zone.id]" cdkDrag [cdkDragDisabled]="true"
                                    class="zone-item item-correct" [style.borderLeftColor]="zone.colorCode">
                                    <img *ngIf="item.imageUrl" [src]="item.imageUrl" class="zone-item-image"
                                        [alt]="item.text" />
                                    <span class="item-text">{{ item.text }}</span>
                                    <span class="result-check">โ</span>
                                </div>

                                <div *ngIf="!zoneItems[zone.id]?.length" class="zone-empty">
                                    <p *ngIf="selectedItem">ุงุถุบุท ููุง ููุฅููุงุช</p>
                                    <p *ngIf="!selectedItem">ุงุณุญุจ ููุง</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== MOBILE LAYOUT (<1024px) ========== -->
        <div class="mobile-layout" *ngIf="isMobile">
            <div class="mobile-game-area">

                <!-- Mobile Store (Left side) -->
                <div class="mobile-store">
                    <h3 class="mobile-store-title">๐ฆ ุงููุฎุฒู ({{ availableItems.length }})</h3>

                    <div cdkDropList [cdkDropListData]="availableItems" class="mobile-store-items"
                        (cdkDropListDropped)="drop($event, -1)" [id]="'mobile-store-list'">

                        <div *ngFor="let item of availableItems" cdkDrag [cdkDragData]="item" class="mobile-item-card"
                            [class.selected]="selectedItem?.id === item.id"
                            [class.hint-highlight]="hintItemId === item.id"
                            [class.shake-error]="shakeItemId === item.id" (click)="onItemTap(item)"
                            (cdkDragStarted)="onDragStarted($event)" (cdkDragEnded)="onDragEnded($event)"
                            [attr.aria-label]="item.text">

                            <img *ngIf="item.imageUrl" [src]="item.imageUrl" class="mobile-item-image"
                                [alt]="item.text" />
                            <span class="mobile-item-text">{{ item.text }}</span>
                            <div class="mobile-item-actions">
                                <button *ngIf="item.audioUrl" class="mobile-audio-btn"
                                    (click)="playItemAudio(item, $event)"
                                    [class.playing]="playingAudioItemId === item.id">
                                    {{ playingAudioItemId === item.id ? 'โธ' : '๐' }}
                                </button>
                                <span class="mobile-tap-check"
                                    *ngIf="inputMode === 'tap' && selectedItem?.id === item.id">โ</span>
                            </div>

                            <div *cdkDragPlaceholder class="mobile-placeholder">
                                <span>{{ item.text }}</span>
                            </div>
                        </div>

                        <div *ngIf="availableItems.length === 0" class="mobile-empty-store">
                            <span>โจ</span>
                        </div>
                    </div>
                </div>

                <!-- Mobile Zones (Right side, horizontal scroll) -->
                <div class="mobile-zones-wrapper">
                    <!-- Zone Dots -->
                    <div class="zone-dots">
                        <span *ngFor="let zone of zones; let i = index" class="zone-dot"
                            [class.active]="i === activeZoneIndex" (click)="scrollToZone(i)"></span>
                    </div>

                    <div class="mobile-zones-scroll" #mobileZonesScroll (scroll)="onZoneScroll($event)">
                        <div *ngFor="let zone of zones; let zi = index" class="mobile-zone-card"
                            [class.zone-droppable]="isDragging || selectedItem"
                            [class.zone-hint]="hintZoneId === zone.id" (click)="onZoneTap(zone.id)">

                            <div class="mobile-zone-header" [style.background]="zone.colorCode + '33'">
                                <div class="mobile-zone-header-left">
                                    <span class="zone-number-badge small">{{ zi + 1 }}</span>
                                    <span class="mobile-zone-label">{{ zone.label }}</span>
                                </div>
                                <span class="mobile-zone-counter">
                                    {{ getZonePlacedCount(zone.id) }}/{{ getZoneExpectedCount(zone.id) }}
                                </span>
                            </div>

                            <div cdkDropList [cdkDropListData]="zoneItems[zone.id]" class="mobile-zone-content"
                                (cdkDropListDropped)="drop($event, zone.id)" [id]="'mobile-zone-' + zone.id">

                                <div *ngFor="let item of zoneItems[zone.id]" class="mobile-zone-item"
                                    [style.borderLeftColor]="zone.colorCode">
                                    <img *ngIf="item.imageUrl" [src]="item.imageUrl" class="zone-item-image"
                                        [alt]="item.text" />
                                    <span>{{ item.text }}</span>
                                    <span class="result-check">โ</span>
                                </div>

                                <div *ngIf="!zoneItems[zone.id]?.length" class="mobile-zone-empty">
                                    <span class="zone-empty-icon">๐ฅ</span>
                                    <span class="zone-empty-action" *ngIf="selectedItem">ุงุถุบุท ููุง!</span>
                                    <span class="zone-empty-hint" *ngIf="!selectedItem">{{ inputMode === 'tap' ? 'ุงุฎุชุฑ
                                        ุจุทุงูุฉ ุซู ุงุถุบุท ููุง' : 'ุงุณุญุจ ุจุทุงูุฉ ููุง' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Selected Item Indicator -->
        <div class="selected-item-bar" *ngIf="isMobile && selectedItem">
            <span>โ {{ selectedItem.text }} โ ุงุถุบุท ุนูู ุงูููุทูุฉ ุงูุตุญูุญุฉ</span>
        </div>

    </div>
</div>

<!-- Loading Template -->
<ng-template #loadingTpl>
    <div class="game-container loading-container">
        <div class="spinner"></div>
        <p class="loading-text">ุฌุงุฑู ุชุญููู ุงููุนุจุฉ...</p>
    </div>
</ng-template>

<!-- ========== RESULTS MODAL ========== -->
<div class="modal-overlay animate-fade-in" *ngIf="showResults && gameResult">
    <div class="modal-content animate-bounce-in">

        <div class="confetti-container">
            <div *ngFor="let piece of confettiPieces" class="confetti-piece" [style.left.%]="piece.x"
                [style.animationDelay.s]="piece.delay" [style.backgroundColor]="piece.color"></div>
        </div>

        <div class="result-icon-large">
            {{ gameResult.stars === 3 ? '๐' : gameResult.stars === 2 ? '๐' : '๐' }}
        </div>
        <h2 class="result-title">{{ getCompletionMessage() }}</h2>

        <!-- Stars -->
        <div class="stars-row">
            <span *ngFor="let s of [1,2,3]" class="star" [class.earned]="gameResult.stars >= s"
                [style.animationDelay.ms]="s * 200">
                {{ gameResult.stars >= s ? 'โญ' : 'โ' }}
            </span>
        </div>

        <!-- Stats Grid -->
        <div class="result-stats-grid">
            <div class="stat-item">
                <span class="stat-value">{{ gameResult.totalScore }}/{{ gameResult.maxPossibleScore }}</span>
                <span class="stat-label">ุงูููุงุท</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ getAccuracyPercentage() }}%</span>
                <span class="stat-label">ุงูุฏูุฉ</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ bestStreak }}</span>
                <span class="stat-label">๐ฅ ุฃูุถู ุณูุณูุฉ</span>
            </div>
        </div>

        <p class="time-display">โฑ๏ธ {{ formatTime(gameResult.timeSpentSeconds) }}</p>

        <div class="modal-actions">
            <button class="btn-primary" (click)="restartGame()">ุงูุนุจ ูุฑุฉ ุฃุฎุฑู ๐</button>
            <button class="btn-secondary" (click)="goBack()">ุงูุนูุฏุฉ โ</button>
        </div>
    </div>
</div>