<!-- Toast Notification -->
<div *ngIf="toastVisible"
    class="toast-notification"
    [class.toast-success]="toastType === 'success'"
    [class.toast-error]="toastType === 'error'"
    [class.toast-info]="toastType === 'info'">
    <div class="flex items-center gap-3">
        <span class="toast-icon" *ngIf="toastType === 'success'">โ</span>
        <span class="toast-icon" *ngIf="toastType === 'error'">โ</span>
        <span class="toast-icon" *ngIf="toastType === 'info'">โน๏ธ</span>
        <span class="font-medium">{{ toastMessage }}</span>
    </div>
</div>

<div class="container mx-auto px-4 py-8 max-w-4xl" dir="rtl">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-8">
        <button [routerLink]="['/admin/wheel-questions']"
            class="p-2 rounded-full hover:bg-slate-100 text-slate-500 transition-colors">
            <lucide-icon name="arrow-right" class="w-6 h-6"></lucide-icon>
        </button>
        <div>
            <h1 class="text-2xl font-bold text-slate-800">
                {{ isEditMode ? 'ุชุนุฏูู ุณุคุงู' : 'ุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ' }}
            </h1>
            <p class="text-slate-500 mt-1">
                {{ isEditMode ? 'ุชุนุฏูู ุจูุงูุงุช ุงูุณุคุงู ุงูุญุงูู' : 'ุฅุฏุฎุงู ุจูุงูุงุช ุณุคุงู ุฌุฏูุฏ ูููุณุงุจูุฉ' }}
            </p>
        </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4 text-slate-500">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p>
    </div>

    <!-- Form Completion Progress -->
    <div *ngIf="!loading" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-slate-700">ุงูุชูุงู ุงููููุฐุฌ</span>
            <span class="text-sm font-bold" [class.text-green-600]="completionPercentage === 100"
                [class.text-blue-600]="completionPercentage < 100">
                {{ completionPercentage }}%
            </span>
        </div>
        <div class="w-full bg-slate-200 rounded-full h-2.5">
            <div class="h-2.5 rounded-full transition-all duration-500"
                [class.bg-green-500]="completionPercentage === 100"
                [class.bg-blue-500]="completionPercentage < 100"
                [style.width.%]="completionPercentage">
            </div>
        </div>
        <div class="flex flex-wrap gap-2 mt-3" *ngIf="submitted && !isFormValid">
            <span *ngFor="let error of getFormErrors()"
                class="text-xs text-red-600 bg-red-50 px-2 py-1 rounded-full">
                โ๏ธ {{ error }}
            </span>
        </div>
    </div>

    <form *ngIf="!loading" (ngSubmit)="saveQuestion()" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">

        <!-- Main Info Card -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:col-span-2 space-y-6">
            <h2 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-4">ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Grade -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ุงูุตู ุงูุฏุฑุงุณู <span
                            class="text-red-500">*</span></label>
                    <select [(ngModel)]="model.gradeId" name="gradeId"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option [ngValue]="3">ุงูุตู ุงูุซุงูุซ</option>
                        <option [ngValue]="4">ุงูุตู ุงูุฑุงุจุน</option>
                        <option [ngValue]="5">ุงูุตู ุงูุฎุงูุณ</option>
                        <option [ngValue]="6">ุงูุตู ุงูุณุงุฏุณ</option>
                    </select>
                    <p class="text-xs text-slate-400 mt-1">๐ก ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู ุงููุณุชูุฏู</p>
                </div>

                <!-- Subject -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ุงููุงุฏุฉ <span
                            class="text-red-500">*</span></label>
                    <select [(ngModel)]="model.subjectId" name="subjectId"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option [ngValue]="1">ุงููุบุฉ ุงูุนุฑุจูุฉ</option>
                        <option [ngValue]="2">ุงูุฑูุงุถูุงุช</option>
                        <option [ngValue]="3">ุงูุนููู</option>
                    </select>
                    <p class="text-xs text-slate-400 mt-1">๐ก ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ ููุณุคุงู</p>
                </div>

                <!-- Difficulty -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ูุณุชูู ุงูุตุนูุจุฉ <span
                            class="text-red-500">*</span></label>
                    <select [(ngModel)]="model.difficultyLevel" name="difficultyLevel"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option [ngValue]="1">ุณูู</option>
                        <option [ngValue]="2">ูุชูุณุท</option>
                        <option [ngValue]="3">ุตุนุจ</option>
                    </select>
                    <p class="text-xs text-slate-400 mt-1">๐ก ุณูู = ุตู 3-4ุ ูุชูุณุท = ุตู 5ุ ุตุนุจ = ุตู 6</p>
                </div>
            </div>

            <!-- Question Text -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">ูุต ุงูุณุคุงู <span
                        class="text-red-500">*</span></label>
                <textarea [(ngModel)]="model.questionText" name="questionText" rows="3" required
                    class="w-full px-4 py-2 rounded-lg border focus:ring-2 outline-none transition-colors"
                    [class.border-red-400]="submitted && !isQuestionTextValid"
                    [class.focus:ring-red-300]="submitted && !isQuestionTextValid"
                    [class.border-slate-300]="!submitted || isQuestionTextValid"
                    [class.focus:ring-blue-500]="!submitted || isQuestionTextValid"
                    placeholder="ุงูุชุจ ูุต ุงูุณุคุงู ููุง... ูุซุงู: ูุง ูู ุนุงุตูุฉ ูุตุฑุ"></textarea>
                <div class="flex justify-between items-center mt-1">
                    <p *ngIf="submitted && !isQuestionTextValid" class="text-xs text-red-500">
                        โ๏ธ ูุต ุงูุณุคุงู ูุทููุจ (5 ุฃุญุฑู ุนูู ุงูุฃูู)
                    </p>
                    <p *ngIf="!submitted || isQuestionTextValid" class="text-xs text-slate-400">
                        ๐ก ุงูุชุจ ุณุคุงูุงู ูุงุถุญุงู ููููู ุงูุทูุงุจ
                    </p>
                    <span class="text-xs" [class.text-slate-400]="model.questionText.length < 5"
                        [class.text-green-500]="model.questionText.length >= 5">
                        {{ model.questionText.length }} ุญุฑู
                    </span>
                </div>
            </div>

            <!-- Category Tag -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">ุงูุชุตููู (ุงุฎุชูุงุฑู)</label>
                <input type="text" [(ngModel)]="model.categoryTag" name="categoryTag"
                    class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none"
                    placeholder="ูุซุงู: ูุญูุ ูููุ ููุฏุณุฉ...">
                <p class="text-xs text-slate-400 mt-1">๐ก ูุณุงุนุฏ ูู ุชุตููู ุงูุฃุณุฆูุฉ ูุณูููุฉ ุงูุจุญุซ</p>
            </div>
        </div>

        <!-- Answers Card -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:col-span-2 space-y-6">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-lg font-semibold text-slate-800">ุงูุฅุฌุงุจุงุช ูุงูุฎูุงุฑุงุช</h2>
                <span class="text-sm font-medium px-3 py-1 rounded-full"
                    [class.bg-blue-100]="!hasDuplicateAnswers" [class.text-blue-700]="!hasDuplicateAnswers"
                    [class.bg-red-100]="hasDuplicateAnswers" [class.text-red-700]="hasDuplicateAnswers">
                    {{ hasDuplicateAnswers ? 'โ๏ธ ููุฌุฏ ุชูุฑุงุฑ!' : 'ุงูุฎูุงุฑุงุช: ' + (model.wrongAnswers.length + 1) }}
                </span>
            </div>

            <!-- Correct Answer -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                    โ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ <span class="text-red-500">*</span>
                </label>
                <input type="text" [(ngModel)]="model.correctAnswer" name="correctAnswer" required
                    class="w-full px-4 py-2 rounded-lg border focus:ring-2 outline-none transition-colors"
                    [class.border-red-400]="submitted && !isCorrectAnswerValid"
                    [class.border-green-300]="!submitted || isCorrectAnswerValid"
                    [class.focus:ring-green-500]="!submitted || isCorrectAnswerValid"
                    [class.bg-green-50]="!submitted || isCorrectAnswerValid"
                    placeholder="ุงูุชุจ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ">
                <p *ngIf="submitted && !isCorrectAnswerValid" class="text-xs text-red-500 mt-1">
                    โ๏ธ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูุทููุจุฉ
                </p>
                <p *ngIf="!submitted || isCorrectAnswerValid" class="text-xs text-slate-400 mt-1">
                    ๐ก ูุฐู ุงูุฅุฌุงุจุฉ ุงูุชู ุณุชุธูุฑ ุจุงูููู ุงูุฃุฎุถุฑ ููุทุงูุจ
                </p>
            </div>

            <!-- Wrong Answers -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-slate-700">
                        โ ุงูุฅุฌุงุจุงุช ุงูุฎุงุทุฆุฉ (ุงููุดุชุชุงุช) <span class="text-red-500">*</span>
                    </label>
                    <span class="text-xs font-medium px-2 py-1 rounded-full bg-slate-100 text-slate-600">
                        {{ model.wrongAnswers.length }} / {{ MAX_WRONG_ANSWERS }}
                    </span>
                </div>

                <div class="space-y-3">
                    <div *ngFor="let wrong of model.wrongAnswers; let i = index; trackBy: trackByIndex"
                        class="flex gap-2 items-center">
                        <span
                            class="flex-shrink-0 w-7 h-7 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-xs font-bold">
                            {{ i + 1 }}
                        </span>
                        <input type="text" [(ngModel)]="model.wrongAnswers[i]" [name]="'wrongAnswer' + i"
                            class="flex-1 px-4 py-2 rounded-lg border focus:ring-2 outline-none transition-colors"
                            [class.border-red-400]="submitted && !model.wrongAnswers[i].trim()"
                            [class.border-red-200]="!submitted || model.wrongAnswers[i].trim()"
                            [class.focus:ring-red-200]="true"
                            [class.bg-red-50]="true"
                            placeholder="ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ {{ i + 1 }}">
                        <button type="button" (click)="removeWrongAnswer(i)" [disabled]="!canRemove"
                            class="p-2 rounded-lg transition-colors"
                            [class.text-red-400]="canRemove" [class.hover:text-red-600]="canRemove"
                            [class.hover:bg-red-100]="canRemove"
                            [class.text-slate-300]="!canRemove" [class.cursor-not-allowed]="!canRemove">
                            <lucide-icon name="trash-2" class="w-5 h-5"></lucide-icon>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between mt-3">
                    <button type="button" (click)="addWrongAnswer()" [disabled]="!canAddMore"
                        class="text-sm font-medium flex items-center gap-1 px-3 py-1.5 rounded-lg transition-colors"
                        [class.text-blue-600]="canAddMore" [class.hover:bg-blue-50]="canAddMore"
                        [class.text-slate-400]="!canAddMore" [class.cursor-not-allowed]="!canAddMore">
                        <lucide-icon name="plus" class="w-4 h-4"></lucide-icon>
                        ุฅุถุงูุฉ ุฎูุงุฑ ุฎุงุทุฆ ุขุฎุฑ
                    </button>
                    <span *ngIf="submitted && hasEmptyWrongAnswers" class="text-xs text-red-500">
                        โ๏ธ ุฌููุน ุงูุฎุงูุงุช ูุฌุจ ููุคูุง
                    </span>
                </div>

                <!-- Duplicate Warning -->
                <div *ngIf="hasDuplicateAnswers"
                    class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-center gap-2">
                    <span class="text-amber-500 text-lg">โ๏ธ</span>
                    <span class="text-sm text-amber-700">ููุฌุฏ ุชูุฑุงุฑ ูู ุงูุฅุฌุงุจุงุช! ุชุฃูุฏ ุฃู ูู ุฅุฌุงุจุฉ ูุฎุชููุฉ ุนู ุงูุฃุฎุฑู</span>
                </div>
            </div>
        </div>

        <!-- Settings Card -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:col-span-2 space-y-6">
            <h2 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-4">ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Points -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ูููุฉ ุงูููุงุท</label>
                    <input type="number" [(ngModel)]="model.pointsValue" name="pointsValue"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                    <p class="text-xs text-slate-400 mt-1">๐ก ุชูุญุณุจ ุชููุงุฆูุงู ุญุณุจ ุงูุตุนูุจุฉ ุฅู ุชูุฑูุช 0</p>
                </div>

                <!-- Time Limit -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ููุช ุงูุฅุฌุงุจุฉ (ุซูุงูู)</label>
                    <input type="number" [(ngModel)]="model.timeLimit" name="timeLimit"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                    <p class="text-xs text-slate-400 mt-1">๐ก ุงูุงูุชุฑุงุถู 30 ุซุงููุฉ</p>
                </div>

                <!-- Test Type -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ููุน ุงูุงุฎุชุจุงุฑ</label>
                    <select [(ngModel)]="testType" name="testType"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option [ngValue]="1">ุงุฎุชุจุงุฑ ูุงูุณ</option>
                        <option [ngValue]="2">ุงูุงุฎุชุจุงุฑ ุงููุฑูุฒู</option>
                    </select>
                    <p class="text-xs text-slate-400 mt-1">๐ก ููุน ุงูุงุฎุชุจุงุฑ ุงูุฐู ููุชูู ุฅููู ุงูุณุคุงู</p>
                </div>

                <!-- Hint -->
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-slate-700 mb-1">ุชูููุญ (ุงุฎุชูุงุฑู)</label>
                    <input type="text" [(ngModel)]="model.hintText" name="hintText"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="ุชูููุญ ูุธูุฑ ููุทุงูุจ ุนูุฏ ุงูุทูุจ...">
                    <p class="text-xs text-slate-400 mt-1">๐ก ูุณุชุฎุฏู ุงูุทุงูุจ ุงูุชูููุญ ููุงุจู ุฎุตู ููุงุท</p>
                </div>

                <!-- Explanation -->
                <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-slate-700 mb-1">ุงูุดุฑุญ (ูุธูุฑ ุจุนุฏ ุงูุฅุฌุงุจุฉ)</label>
                    <textarea [(ngModel)]="model.explanation" name="explanation" rows="2"
                        class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="ุดุฑุญ ุณุจุจ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ..."></textarea>
                    <p class="text-xs text-slate-400 mt-1">๐ก ูุธูุฑ ููุทุงูุจ ุจุนุฏ ุงุฎุชูุงุฑ ุฅุฌุงุจุชู ูุชุนูููู</p>
                </div>
            </div>
        </div>

        <!-- Submit Action -->
        <div class="md:col-span-2 flex justify-end gap-4 mt-4">
            <button type="button" [routerLink]="['/admin/wheel-questions']"
                class="px-6 py-2.5 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors">
                ุฅูุบุงุก
            </button>
            <button type="submit" [disabled]="saving"
                class="px-8 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-colors shadow-lg shadow-blue-200">
                <div *ngIf="saving" class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                <lucide-icon *ngIf="!saving" name="save" class="w-5 h-5"></lucide-icon>
                <span>{{ saving ? 'ุฌุงุฑู ุงูุญูุธ...' : (isEditMode ? 'ุชุญุฏูุซ ุงูุณุคุงู' : 'ุญูุธ ุงูุณุคุงู') }}</span>
            </button>
        </div>

    </form>
</div>